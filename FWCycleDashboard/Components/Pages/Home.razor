@page "/"
@rendermode InteractiveServer
@using FWCycleDashboard.Data
@using FWCycleDashboard.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@inject ApplicationDbContext DbContext
@inject RemoteSupervisorClient SupervisorClient
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Dashboard</PageTitle>

<h1>Cycle Monitor Dashboard</h1>

<div class="mb-3">
    <button class="btn btn-primary" @onclick="RefreshAll" disabled="@isRefreshing">
        @if (isRefreshing)
        {
            <span class="spinner-border spinner-border-sm me-2"></span>
        }
        Refresh All
    </button>
    <button class="btn btn-secondary ms-2" @onclick="ToggleAutoRefresh">
        Auto-Refresh: @(autoRefreshEnabled ? "On" : "Off")
    </button>
    <button class="btn btn-info ms-2" @onclick="ToggleBulkActions">
        Bulk Actions: @(showBulkActions ? "Hide" : "Show")
    </button>
</div>

@if (showBulkActions && machineStatuses != null && machineStatuses.Any())
{
    <div class="card mb-3 bg-light">
        <div class="card-header">
            <strong>Bulk Operations</strong>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label"><strong>Target:</strong></label>
                    <select class="form-select" @bind="bulkTarget">
                        <option value="all">All Machines</option>
                        @foreach (var group in groups)
                        {
                            <option value="group-@group.Id">Group: @group.Name</option>
                        }
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="btn-toolbar" role="toolbar">
                        <div class="btn-group me-2 mb-2" role="group">
                            <button class="btn btn-danger" @onclick="BulkRebootPi" disabled="@isBulkOperating">
                                @if (isBulkOperating && currentBulkOp == "reboot")
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Reboot Pi
                            </button>
                        </div>

                        <div class="btn-group me-2 mb-2" role="group">
                            <button class="btn btn-outline-success" @onclick="() => BulkStackLight(true, false, false)" disabled="@isBulkOperating">Green</button>
                            <button class="btn btn-outline-warning" @onclick="() => BulkStackLight(false, true, false)" disabled="@isBulkOperating">Amber</button>
                            <button class="btn btn-outline-danger" @onclick="() => BulkStackLight(false, false, true)" disabled="@isBulkOperating">Red</button>
                            <button class="btn btn-outline-secondary" @onclick="() => BulkStackLight(false, false, false)" disabled="@isBulkOperating">All Off</button>
                        </div>

                        <div class="btn-group mb-2" role="group">
                            <button class="btn btn-outline-primary" @onclick="BulkTestStackLight" disabled="@isBulkOperating">
                                @if (isBulkOperating && currentBulkOp == "test")
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Test Lights
                            </button>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(bulkOperationStatus))
                    {
                        <div class="alert alert-info mt-2">
                            @bulkOperationStatus
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@if (machineStatuses == null)
{
    <p><em>Loading...</em></p>
}
else if (!machineStatuses.Any())
{
    <div class="alert alert-info">
        <h4>No machines configured</h4>
        <p>Get started by adding machines to monitor.</p>
        <a href="/machines" class="btn btn-primary">Add Machines</a>
    </div>
}
else
{
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5>Online</h5>
                    <h2>@machineStatuses.Count(m => m.IsOnline && m.Status?.ActiveState == "active")</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5>Stopped</h5>
                    <h2>@machineStatuses.Count(m => m.IsOnline && m.Status?.ActiveState != "active")</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <h5>Offline</h5>
                    <h2>@machineStatuses.Count(m => !m.IsOnline)</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5>Total</h5>
                    <h2>@machineStatuses.Count</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        @foreach (var status in machineStatuses)
        {
            var machine = machines.FirstOrDefault(m => m.Id == status.MachineId);
            if (machine != null)
            {
                <div class="col-md-4 mb-3">
                    <div class="card @GetCardClass(status)">
                        <div class="card-header">
                            <strong>@machine.MachineId</strong>
                            <span class="badge @GetStatusBadge(status) float-end">
                                @(status.IsOnline ? (status.Status?.ActiveState ?? "unknown") : "offline")
                            </span>
                        </div>
                        <div class="card-body">
                            @if (machine.Group != null)
                            {
                                <p class="text-muted"><small>Group: @machine.Group.Name</small></p>
                            }
                            <p><small>@machine.IpAddress:@machine.Port</small></p>
                            @if (status.IsOnline && status.Status != null)
                            {
                                <p><small>PID: @status.Status.Pid</small></p>
                                @if (status.Status.UptimeSeconds.HasValue)
                                {
                                    <p><small>Uptime: @FormatUptime(status.Status.UptimeSeconds.Value)</small></p>
                                }
                            }

                            @if (status.IsOnline && status.Metrics != null)
                            {
                                <div class="border-top mt-2 pt-2">
                                    <small class="text-muted d-block mb-1"><strong>Cycle Times:</strong></small>
                                    @if (status.Metrics.LastCycleSeconds.HasValue)
                                    {
                                        <p class="mb-1"><small><strong>Last:</strong> @FormatCycleTime(status.Metrics.LastCycleSeconds.Value)</small></p>
                                    }
                                    else
                                    {
                                        <p class="mb-1"><small><strong>Last:</strong> No data</small></p>
                                    }

                                    @if (status.Metrics.WindowAverages != null && status.Metrics.WindowAverages.Any())
                                    {
                                        @foreach (var window in status.Metrics.WindowAverages.OrderBy(w => ParseWindowMinutes(w.Key)))
                                        {
                                            <p class="mb-1">
                                                <small>
                                                    <strong>@window.Key avg:</strong>
                                                    @if (window.Value.HasValue)
                                                    {
                                                        @FormatCycleTime(window.Value.Value)
                                                    }
                                                    else
                                                    {
                                                        <text>No data</text>
                                                    }
                                                </small>
                                            </p>
                                        }
                                    }
                                </div>
                            }
                        </div>
                        <div class="card-footer">
                            <div class="mb-2">
                                <button class="btn btn-sm btn-success" @onclick="() => StartService(machine)" disabled="@(!status.IsOnline)">Start</button>
                                <button class="btn btn-sm btn-warning" @onclick="() => RestartService(machine)" disabled="@(!status.IsOnline)">Restart</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => StopService(machine)" disabled="@(!status.IsOnline)">Stop</button>
                            </div>
                            <div class="mb-2">
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => RebootPi(machine)" disabled="@(!status.IsOnline)">
                                    Reboot Pi
                                </button>
                            </div>

                            @if (status.StackLight != null)
                            {
                                <div class="border-top pt-2">
                                    <small class="text-muted d-block mb-1">Stack Lights:</small>
                                    <div class="btn-group btn-group-sm mb-1" role="group">
                                        <button class="btn @(status.StackLight.Green ? "btn-success" : "btn-outline-success")"
                                                @onclick="() => SetStackLight(machine, true, false, false)"
                                                disabled="@(!status.IsOnline)">
                                            Green
                                        </button>
                                        <button class="btn @(status.StackLight.Amber ? "btn-warning" : "btn-outline-warning")"
                                                @onclick="() => SetStackLight(machine, false, true, false)"
                                                disabled="@(!status.IsOnline)">
                                            Amber
                                        </button>
                                        <button class="btn @(status.StackLight.Red ? "btn-danger" : "btn-outline-danger")"
                                                @onclick="() => SetStackLight(machine, false, false, true)"
                                                disabled="@(!status.IsOnline)">
                                            Red
                                        </button>
                                    </div>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-secondary"
                                                @onclick="() => TestStackLight(machine)"
                                                disabled="@(!status.IsOnline)">
                                            Test
                                        </button>
                                        <button class="btn btn-outline-secondary"
                                                @onclick="() => TurnOffStackLight(machine)"
                                                disabled="@(!status.IsOnline)">
                                            All Off
                                        </button>
                                    </div>
                                    @if (!string.IsNullOrEmpty(status.StackLight.LastUpdated))
                                    {
                                        <small class="text-muted d-block mt-1">
                                            Updated: @FormatTimestamp(status.StackLight.LastUpdated)
                                        </small>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    private List<Machine> machines = new();
    private List<MachineGroup> groups = new();
    private List<MachineStatus>? machineStatuses;
    private bool isRefreshing = false;
    private bool autoRefreshEnabled = true;
    private bool showBulkActions = false;
    private bool isBulkOperating = false;
    private string bulkTarget = "all";
    private string? bulkOperationStatus;
    private string? currentBulkOp;
    private System.Threading.Timer? refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadMachines();
        await RefreshAll();
        StartAutoRefresh();
    }

    private async Task LoadMachines()
    {
        machines = await DbContext.Machines.Include(m => m.Group).ToListAsync();
        groups = await DbContext.MachineGroups.ToListAsync();
    }

    private void ToggleBulkActions()
    {
        showBulkActions = !showBulkActions;
        bulkOperationStatus = null;
    }

    private async Task RefreshAll()
    {
        isRefreshing = true;
        StateHasChanged();
        try
        {
            var tasks = machines.Select(m => SupervisorClient.GetFullStatusAsync(m));
            machineStatuses = (await Task.WhenAll(tasks)).ToList();
            foreach (var status in machineStatuses.Where(s => s.IsOnline))
            {
                var machine = machines.FirstOrDefault(m => m.Id == status.MachineId);
                if (machine != null)
                {
                    machine.LastSeenAt = DateTime.UtcNow;
                    machine.LastStatus = status.Status?.ActiveState;
                }
            }
            await DbContext.SaveChangesAsync();
        }
        finally
        {
            isRefreshing = false;
            StateHasChanged();
        }
    }

    private async Task StartService(Machine machine)
    {
        var (success, error) = await SupervisorClient.StartServiceAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "start",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        await Task.Delay(1000);
        await RefreshAll();
    }

    private async Task StopService(Machine machine)
    {
        var (success, error) = await SupervisorClient.StopServiceAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "stop",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        await Task.Delay(1000);
        await RefreshAll();
    }

    private async Task RestartService(Machine machine)
    {
        var (success, error) = await SupervisorClient.RestartServiceAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "restart",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        await Task.Delay(1000);
        await RefreshAll();
    }

    private string GetCardClass(MachineStatus status)
    {
        if (!status.IsOnline) return "border-secondary";
        return status.Status?.ActiveState == "active" ? "border-success" : "border-danger";
    }

    private string GetStatusBadge(MachineStatus status)
    {
        if (!status.IsOnline) return "bg-secondary";
        return status.Status?.ActiveState == "active" ? "bg-success" : "bg-danger";
    }

    private string FormatUptime(double seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        if (ts.TotalDays >= 1)
            return $"{(int)ts.TotalDays}d {ts.Hours}h";
        if (ts.TotalHours >= 1)
            return $"{(int)ts.TotalHours}h {ts.Minutes}m";
        return $"{(int)ts.TotalMinutes}m";
    }

    private void StartAutoRefresh()
    {
        refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (autoRefreshEnabled)
            {
                await InvokeAsync(async () => await RefreshAll());
            }
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private void ToggleAutoRefresh()
    {
        autoRefreshEnabled = !autoRefreshEnabled;
    }

    private async Task SetStackLight(Machine machine, bool green, bool amber, bool red)
    {
        var (success, error) = await SupervisorClient.SetStackLightAsync(machine, green, amber, red);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = $"stacklight: G={green} A={amber} R={red}",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        await Task.Delay(500);
        await RefreshAll();
    }

    private async Task TestStackLight(Machine machine)
    {
        var (success, error) = await SupervisorClient.TestStackLightAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "stacklight: test",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        // Wait for test sequence to complete (8 seconds) plus buffer
        await Task.Delay(9000);
        await RefreshAll();
    }

    private async Task TurnOffStackLight(Machine machine)
    {
        var (success, error) = await SupervisorClient.TurnOffStackLightAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "stacklight: all off",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        await Task.Delay(500);
        await RefreshAll();
    }

    private string FormatTimestamp(string? timestamp)
    {
        if (string.IsNullOrEmpty(timestamp))
            return "Unknown";

        if (DateTime.TryParse(timestamp, out var dt))
        {
            var localTime = dt.ToLocalTime();
            var diff = DateTime.Now - localTime;

            if (diff.TotalSeconds < 60)
                return "Just now";
            if (diff.TotalMinutes < 60)
                return $"{(int)diff.TotalMinutes}m ago";
            if (diff.TotalHours < 24)
                return $"{(int)diff.TotalHours}h ago";

            return localTime.ToString("g");
        }

        return timestamp;
    }

    private string FormatCycleTime(double seconds)
    {
        return $"{seconds:F1}s";
    }

    private int ParseWindowMinutes(string windowKey)
    {
        // Extract number from strings like "5min", "15min", "30min", "60min"
        var numericPart = new string(windowKey.TakeWhile(char.IsDigit).ToArray());
        return int.TryParse(numericPart, out var minutes) ? minutes : int.MaxValue;
    }

    private async Task RebootPi(Machine machine)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Reboot {machine.MachineId}? The Raspberry Pi will restart and may take 1-2 minutes to come back online."
        );

        if (!confirmed) return;

        var (success, error) = await SupervisorClient.RebootPiAsync(machine);

        DbContext.CommandHistory.Add(new CommandHistory
        {
            MachineId = machine.Id,
            Command = "system: reboot",
            Success = success,
            Error = error
        });
        await DbContext.SaveChangesAsync();

        // Pi will be offline during reboot, wait 30 seconds before refresh
        await Task.Delay(30000);
        await RefreshAll();
    }

    private List<Machine> GetTargetMachines()
    {
        if (bulkTarget == "all")
        {
            return machines;
        }
        else if (bulkTarget.StartsWith("group-"))
        {
            var groupId = int.Parse(bulkTarget.Substring(6));
            return machines.Where(m => m.GroupId == groupId).ToList();
        }
        return new List<Machine>();
    }

    private async Task BulkRebootPi()
    {
        var targetMachines = GetTargetMachines();
        var onlineMachines = targetMachines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any())
        {
            bulkOperationStatus = "No online machines found in selection.";
            return;
        }

        var confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            $"Reboot {onlineMachines.Count} machine(s)? All selected Raspberry Pis will restart."
        );

        if (!confirmed) return;

        isBulkOperating = true;
        currentBulkOp = "reboot";
        bulkOperationStatus = $"Rebooting {onlineMachines.Count} machine(s)...";
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.RebootPiAsync(machine);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = "system: reboot (bulk)",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            var results = await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            var successCount = results.Count(r => r.success);
            bulkOperationStatus = $"Reboot initiated: {successCount}/{onlineMachines.Count} successful. Waiting 30s...";
            StateHasChanged();

            await Task.Delay(30000);
            await RefreshAll();

            bulkOperationStatus = $"Reboot complete: {successCount}/{onlineMachines.Count} machines rebooted.";
        }
        finally
        {
            isBulkOperating = false;
            currentBulkOp = null;
            StateHasChanged();
        }
    }

    private async Task BulkStackLight(bool green, bool amber, bool red)
    {
        var targetMachines = GetTargetMachines();
        var onlineMachines = targetMachines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any())
        {
            bulkOperationStatus = "No online machines found in selection.";
            return;
        }

        isBulkOperating = true;
        var lightState = green ? "Green" : amber ? "Amber" : red ? "Red" : "Off";
        bulkOperationStatus = $"Setting {onlineMachines.Count} machine(s) to {lightState}...";
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.SetStackLightAsync(machine, green, amber, red);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = $"stacklight (bulk): G={green} A={amber} R={red}",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            var results = await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            var successCount = results.Count(r => r.success);
            bulkOperationStatus = $"Stack lights updated: {successCount}/{onlineMachines.Count} successful.";

            await Task.Delay(500);
            await RefreshAll();
        }
        finally
        {
            isBulkOperating = false;
            StateHasChanged();
        }
    }

    private async Task BulkTestStackLight()
    {
        var targetMachines = GetTargetMachines();
        var onlineMachines = targetMachines
            .Where(m => machineStatuses?.FirstOrDefault(s => s.MachineId == m.Id)?.IsOnline == true)
            .ToList();

        if (!onlineMachines.Any())
        {
            bulkOperationStatus = "No online machines found in selection.";
            return;
        }

        isBulkOperating = true;
        currentBulkOp = "test";
        bulkOperationStatus = $"Testing lights on {onlineMachines.Count} machine(s)... (8 seconds)";
        StateHasChanged();

        try
        {
            var tasks = onlineMachines.Select(async machine =>
            {
                var (success, error) = await SupervisorClient.TestStackLightAsync(machine);
                DbContext.CommandHistory.Add(new CommandHistory
                {
                    MachineId = machine.Id,
                    Command = "stacklight: test (bulk)",
                    Success = success,
                    Error = error
                });
                return (machine, success, error);
            });

            var results = await Task.WhenAll(tasks);
            await DbContext.SaveChangesAsync();

            var successCount = results.Count(r => r.success);
            bulkOperationStatus = $"Test initiated: {successCount}/{onlineMachines.Count} successful. Waiting for test completion...";
            StateHasChanged();

            await Task.Delay(9000);
            await RefreshAll();

            bulkOperationStatus = $"Test complete: {successCount}/{onlineMachines.Count} machines tested.";
        }
        finally
        {
            isBulkOperating = false;
            currentBulkOp = null;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }
}
